<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test stream audio</title>
  <style>
    body{font-family: sans-serif;}
    h3{
      text-transform: uppercase;
      text-align:center;
      font-size:18px;
    }
    h5{ margin-top:0px; }
    #statutAppel{
      color:rgb(68, 90, 163);
      font-weight:bold;
      text-transform:uppercase;
      font-size:12px;
    }
    div{
      width:50%;
      border: 1px solid rgb(150,150,150);
      border-radius:10px;
      padding:10px;
    }
    #yn{
      border:none;
      padding-left:0px;
    }
  </style>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
</head>
<script>
  if (location.protocol !== 'https:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
    console.log('replace to https');
  }
</script>
<body>
  <h3>Test audio stream v1 by Marie Bruggeman (server 24)</h3>
  <hr>
  <br/><br/>
  <div>
    <h5>Gestion appel</h5>
    <button id="bstart">Start</button>
    <button id="bstop" disabled>Stop</button>
    <button id="bmute" disabled>Mute</button>
    <br/><br/>
  </div>
  <br/>
  <div>
    <p id="statutAppel">Aucun appel en cours</p>
    <div id="yn">
      <button id="baccepter">Accepter</button>
      <button id="brefuser">Refuser</button>
    </div>
    <audio id="audio" autoplay></audio>
  </div>
<script>
$(document).ready(function() {
  $("#yn").hide();
});

var stream, recorder, sourceBuffer;
const audio = document.getElementById("audio");
const mime = "audio/webm;codecs=opus";

function createAudio(){
  mediaSource = new MediaSource();
  audio.src = URL.createObjectURL(mediaSource);
  mediaSource.addEventListener('sourceopen', function(){
    sourceBuffer = mediaSource.addSourceBuffer(mime);
  });
}

const ws = new WebSocket('wss://www.salutem.co:1338/');
ws.binaryType = 'arraybuffer';
ws.onopen = function() {
  console.log('WebSocket Client Connected');
  createAudio();
};

ws.onmessage = function(evt) {
  msg = evt.data;
  switch (msg) {
    case 'start' :
      console.log("appel reçu");
      $("#statutAppel").html("Appel reçu");
      $("#yn").show();
      break;

    case 'stop' :
      stopCall();
      break;

    case 'accepter' :
      startCall();
      break;

    case 'refuser' :
      $("#statutAppel").html("Appel refusé");
      break;

    default: // Réception des données audio
      if (mediaSource.readyState === 'open') sourceBuffer.appendBuffer(msg);
      break;
  }
};

async function startRecord() {
  if (!stream) stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  if (!recorder) recorder = new MediaRecorder(stream, { mimeType: mime });

  recorder.start(20); // Timeslice de  20ms

  recorder.ondataavailable = async event => {
    var reader = new FileReader();
    reader.addEventListener("loadend", function () {
      ws.send(reader.result);
      console.log(reader.result);
    });
    reader.readAsArrayBuffer(event.data);
  };
}

$("#bstart").click(function(){
  ws.send("start");
  $("#statutAppel").html("Appel demandé");
});

$("#bstop").click(function(){
  ws.send("stop");
  stopCall();
});

$("#baccepter").click(function(){
  ws.send("accepter");
  $("#yn").hide();
  startCall();
});

$("#brefuser").click(function(){
  ws.send("refuser");
  $("#yn").hide();
  $("#statutAppel").html("Appel refusé");
});

$("#bmute").click(function(){
 if(recorder.state == 'recording'){
   recorder.pause();
   $("#bmute").html("Unmute");
 }
 else if(recorder.state == 'paused'){
   recorder.resume();
   $("#bmute").html("Mute");
 }
});

function startCall(){
  startRecord();
  audio.controls = true;
  $("#statutAppel").html("Appel en cours ...");
  $("#bstart").attr("disabled",true);
  $("#bstop, #bmute").attr("disabled",false);
}

function stopCall(){
  console.log("appel terminé");
  audio.controls = false;
  $("#statutAppel").html("Appel terminé");
  $("#bstart").attr("disabled",false);
  $("#bstop, #bmute").attr("disabled",true);
  $("#bmute").html("Mute");

  if (recorder) recorder.stop();
  sourceBuffer.addEventListener('updateend', createAudio);
}
</script>

</body>
</html>