<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test stream audio</title>
  <style>
    body{font-family: sans-serif;}
    h3{
      text-transform: uppercase;
      text-align:center;
    }
    #appel{
      color:rgb(146, 14, 14);
      font-weight:bold;
    }
  </style>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
</head>
<script>
  if (location.protocol !== 'https:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
    console.log('replace to https');
  }
</script>
<body>
  <h3>Test audio stream v1 by Marie Bruggeman (server 24)</h3>
  <hr>
  <br/>
  <button id="start" onclick="start()">Start</button>
  <button id="stop" onclick="stop()" disabled>Stop</button>
  <br/><br/><br/>
  <p id="appel"></p>
  <br/><br/>
  <audio id="audio" autoplay></audio>

<script>
var stream, recorder, sourceBuffer;
const audio = document.getElementById("audio");
const mime = "audio/webm;codecs=opus";
const mediaSource = new MediaSource();
audio.src = URL.createObjectURL(mediaSource);


const ws = new WebSocket('wss://www.salutem.co:1338/');
ws.binaryType = 'arraybuffer';
ws.onopen = function() {
  console.log('WebSocket Client Connected');
};

ws.onmessage = function(evt) {
  if(evt.data == "start"){ // Start
    console.log("appel reçu");
    audio.controls = true;
    $("#appel").html("Appel reçu");
    sourceBuffer = mediaSource.addSourceBuffer("audio/webm;codecs=opus");
  }
  else if(evt.data == "stop"){ // Stop
    console.log("appel terminé");
    audio.controls = false;
    $("#appel").html("");
  }
  else{ // Réception des données audio
    sourceBuffer.appendBuffer(evt.data);
  }
};

async function start() {
  if (!stream) stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  if (!recorder) recorder = new MediaRecorder(stream, { mimeType: mime });

  recorder.start(20); // Timeslice de  20ms

  await new Promise(r => (recorder.onstart = r));
  recorder.ondataavailable = async event => {
    var reader = new FileReader();
    reader.addEventListener("loadend", function () {
      ws.send(reader.result);
      console.log(reader.result);
    });
    reader.readAsArrayBuffer(event.data);
  };
}

$("#start").click(function(){
  ws.send("start");
  $("#appel").html("Appel lancé");
  $("#start").attr("disabled",true);
  $("#stop").attr("disabled",false);
});

$("#stop").click(function(){
  ws.send("stop");
  if (recorder) recorder.stop();
  $("#appel").html("");
  $("#start").attr("disabled",false);
  $("#stop").attr("disabled",true);
});
</script>

</body>
</html>
