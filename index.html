<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test stream audio</title>
  <style>
    body{font-family: sans-serif;}
    h3{
      text-transform: uppercase;
      text-align:center;
    }
    h5{ margin-top:0px; }
    #statutenvoi, #statutreception{
      color:rgb(68, 90, 163);
      font-weight:bold;
      text-transform:uppercase;
      font-size:12px;
    }
    div{
      width:50%;
      border: 1px solid rgb(150,150,150);
      border-radius:10px;
      padding:10px;
    }
  </style>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
</head>

<body>
  <h3>Test audio stream v1 by Marie Bruggeman (server 24)</h3>
  <hr>
  <br/><br/>
  <div>
    <h5>Gestion envoi appel</h5>
    <button id="bstart">Start</button>
    <button id="bstop" disabled>Stop</button>
    <button id="bmute" disabled>Mute</button>
    <br/><br/>
    <p id="statutenvoi">Aucun appel envoyé</p>
  </div>
  <br/>
  <div>
    <h5>Réception appels</h5>
    <p id="statutreception">Aucun appel reçu</p>
    <audio id="audio" autoplay controls></audio>
  </div>

<script>

start = 0;
var stream, recorder;
const audio = document.getElementById("audio");
const mime = "audio/webm;codecs=opus";

audio.onplaying = (e) => { $("#statutreception").html("Appel reçu ..."); }
audio.onwaiting = (e) => { $("#statutreception").html("Appel en pause"); }

function createAudio(){
  mediaSource = new MediaSource();
  audio.src = URL.createObjectURL(mediaSource);
  mediaSource.addEventListener('sourceopen', function(){
    sourceBuffer = mediaSource.addSourceBuffer(mime);
    sourceBuffer.mode = 'sequence';
    console.log("audio créé");
  });
}

const ws = new WebSocket('wss://www.salutem.co:1338/');
//ws.binaryType = 'arraybuffer';
ws.onopen = function() {
  console.log('WebSocket Client Connected');
  createAudio();
};

ws.onmessage = function(evt) {
  msg = JSON.parse(evt.data);
  switch (msg.type) {
    case 'start':
      $("#statutreception").html("Appel reçu ...");
      start = 1;
      break;

    case 'stop':
      console.log("appel terminé");
      $("#statutreception").html("Aucun appel reçu");
      start = 0;
      createAudio();
      break;

    case 'firstchunks':
      mediaSource.addEventListener('sourceopen', function(){
        console.log("réception first chunks");
        sourceBuffer.appendBuffer(Uint8Array.from(msg.data));
        start = 1;
        $("#statutreception").html("Appel reçu ...");
      });
      break;

    case 'audio': // Réception des données audio
      if (start == 1 && mediaSource.readyState === 'open' && sourceBuffer.updating == false){
        console.log(msg.data);
        sourceBuffer.appendBuffer(Uint8Array.from(msg.data));
      }
      break;
  }
};

async function startRecord() {
  if (!stream) stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  if (!recorder) recorder = new MediaRecorder(stream, { mimeType: mime });

  recorder.start(20); // Timeslice de  20ms

  var cpt = 0;
  var firstchunks = [];

  recorder.ondataavailable = async event => {
    if (event.data.size > 0) {
      var reader = new FileReader();
      reader.addEventListener("loadend", function () {
        console.log(reader.result);
        var res = [...new Uint8Array(reader.result)];
        ws.send(JSON.stringify({
          type: "audio",
          data: res
        }));

        // Récupération et envoi des deux premiers paquets de l'enregistrement
        if(cpt < 2){
          firstchunks.push(res);
          cpt ++;
        }
        if(cpt == 2){
          console.log("envoi first chunks");
          ws.send(JSON.stringify({
            type: "firstchunks",
            data: firstchunks
          }));
          cpt = 3;
        }
      });
      reader.readAsArrayBuffer(event.data);
    }
  }
}

$("#bstart").click(function(){
  ws.send(JSON.stringify({
    type: "start"
  }));
  startRecord();
  $("#statutenvoi").html("Appel en cours ...");
  $("#bstart").attr("disabled",true);
  $("#bstop, #bmute").attr("disabled",false);
});

$("#bstop").click(function(){
  ws.send(JSON.stringify({
    type: "stop"
  }));
  if (recorder) recorder.stop();
  $("#statutenvoi").html("Aucun appel envoyé");
  $("#bstart").attr("disabled",false);
  $("#bstop, #bmute").attr("disabled",true);
});

$("#bmute").click(function(){
 if(recorder.state == 'recording'){
   recorder.pause();
   $("#bmute").html("Unmute");
   $("#statutenvoi").html("Appel en pause");
 }
 else if(recorder.state == 'paused'){
   recorder.resume();
   $("#bmute").html("Mute");
   $("#statutenvoi").html("Appel en cours ...");
 }
});

</script>

</body>
</html>
