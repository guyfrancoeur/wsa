<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test stream audio</title>
  <style>
    body{font-family: sans-serif;}
    h3{
      text-transform: uppercase;
      text-align:center;
    }
    #appelRecu{
      color:rgb(146, 14, 14);
      font-weight:bold;
    }
    #appelLance{
      color:rgb(72, 136, 82);
      font-weight:bold;
    }
  </style>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
</head>
<script>
  if (location.protocol !== 'https:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
    console.log('replace to https');
  }
</script>
<body>
  <h3>Test audio stream v1 by Marie Bruggeman (server 24)</h3>
  <hr>
  <br/>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="mute" disabled>Mute</button>
  <br/><br/><br/>
  <p id="appelRecu">Appel reçu</p>
  <p id="appelLance">Appel lancé</p>
  <br/><br/>
  <audio id="audio" autoplay></audio>

<script>
$(document).ready(function() {
  $("#appelRecu, #appelLance").hide();
});

var mute = false;
var stream, recorder, sourceBuffer;
const audio = document.getElementById("audio");
const mime = "audio/webm;codecs=opus";
mediaSource = new MediaSource();
audio.src = URL.createObjectURL(mediaSource);


const ws = new WebSocket('wss://www.salutem.co:1338/');
ws.binaryType = 'arraybuffer';
ws.onopen = function() {
  console.log('WebSocket Client Connected');
};

ws.onmessage = function(evt) {
  message = evt.data;
  if(message == "start"){ // Start
    console.log("appel reçu");
    audio.controls = true;
    $("#appelRecu").show();
    sourceBuffer = mediaSource.addSourceBuffer(mime);
  }
  else if(message == "stop"){ // Stop
    console.log("appel terminé");
    $("#appelRecu").hide();
    audio.controls = false;
    sourceBuffer.addEventListener('updateend', function() {
      mediaSource = new MediaSource();
      audio.src = URL.createObjectURL(mediaSource);
    });
  }
  else if (message.constructor === ArrayBuffer){ // Réception des données audio
    sourceBuffer.appendBuffer(message);
  }
  else if(message == "mute"){
    $("#audio").prop("muted",true);
  }
  else if(message == "unmute"){
    $("#audio").prop("muted",false);
  }
};

async function start() {
  if (!stream) stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  if (!recorder) recorder = new MediaRecorder(stream, { mimeType: mime });

  recorder.start(20); // Timeslice de  20ms

  recorder.ondataavailable = async event => {
    var reader = new FileReader();
    reader.addEventListener("loadend", function () {
      ws.send(reader.result);
      console.log(reader.result);
    });
    reader.readAsArrayBuffer(event.data);
  };
}

$("#start").click(function(){
  ws.send("start");
  start();
  $("#appelLance").show();
  $("#start").attr("disabled",true);
  $("#stop, #mute").attr("disabled",false);
});

$("#stop").click(function(){
  ws.send("stop");
  if (recorder) recorder.stop();
  $("#appelLance").hide();
  $("#start").attr("disabled",false);
  $("#stop, #mute").attr("disabled",true);

  // Unmute
  var mute = false;
  $("#mute").html("Mute");
  ws.send("unmute");
});

$("#mute").click(function(){
  if(mute){
    ws.send("unmute");
    $("#mute").html("Mute");
  }
  else{
    ws.send("mute");
    $("#mute").html("Unmute");
  }
  mute = !mute;
});
</script>

</body>
</html>
